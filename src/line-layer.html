<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="line-layer">
  <template>
    <style>
      path {
        fill: none;
        stroke: #424242;
        stroke-width: 5;
      }
    </style>

    <svg id="lineLayer" width="1240" height="1240" viewBox="0 0 1240 1240">
    </svg>

  </template>

  <script>
    class LineLayer extends Polymer.Element {
      static get is() { return 'line-layer'; }

      static get properties() {
        return {

          // Number of pixels to offset when drawing the relationship lines.
          leftOffset: {
            type: Number,
          }
        }
      }
      drawRelations(tile){
        let relations = tile.relations
        let rect = tile.getBoundingClientRect()

        let tilePosition = {
          left: rect.left - this.leftOffset + window.scrollX,
          top: rect.top + window.scrollY
        }

        for (let i = 0; i < relations.length; i++){
          let line = document.createElementNS('http://www.w3.org/2000/svg',"path")

          let related = relations[i]
          let relatedRect = related.getBoundingClientRect()
          let relatedTilePosition = {
            left: relatedRect.left - this.leftOffset + window.scrollX,
            top: relatedRect.top + window.scrollY
          }

          line.setAttributeNS(null, "id", tile.table.name + "-" + related.table.name)
          line.setAttributeNS(null, "d", "M " + tilePosition.left.toString() + ", " + tilePosition.top.toString() +
                                " L " + relatedTilePosition.left.toString() + ", " + relatedTilePosition.top.toString());
          Polymer.dom(this.$.lineLayer).appendChild(line)
        }
      }

      // Using the `start` and `end` tile, determine
      // the coordinates of where the line will start
      // and end
      getLineEndpoints(start, end){
        // Start Info
        let startBounds = start.getBoundingClientRect()
        let startTilePosition = {
          left: startBounds.left - this.leftOffset + window.scrollX,
          top: startBounds.top + window.scrollY
        }

        // End Info
        let endBounds = end.getBoundingClientRect()
        let endTilePosition = {
          left: endBounds.left - this.leftOffset + window.scrollX,
          top: endBounds.top + window.scrollY
        }

        // TODO: come up with a better way of deciding the points
        // so that they don't always use the top left of the box.
        // This is temporary
        startTilePosition.x = startTilePosition.left
        startTilePosition.y = startTilePosition.top

        endTilePosition.x = endTilePosition.left
        endTilePosition.y = endTilePosition.top

        return {start: startTilePosition, end: endTilePosition}
      }

      // Move the relationship lines for the given tile
      _moveRelationships(tile){

        for (let i = 0; i < tile.relations.length; i++){
          let relation = tile.table.name + "-" + tile.relations[i].table.name
          let coords = this.getLineEndpoints(tile, tile.relations[i])
          let line = Polymer.dom(this.root).querySelector("#" + relation)

          line.setAttribute("d", "M " + coords.start.x.toString() + ", " + coords.start.y.toString() +
                                " L " + coords.end.y.toString() + ", " + coords.end.y.toString());
        }
      }
    }

    customElements.define(LineLayer.is, LineLayer);
  </script>
</dom-module>
